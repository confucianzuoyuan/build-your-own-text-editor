<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>使用 C 语言构建终端文本编辑器</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #408080; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #7D9029 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #A0A000 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>使用 C 语言构建终端文本编辑器</h1>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_设置">1. 设置</a>
<ul class="sectlevel2">
<li><a href="#_如何安装_c_编译器">1.1. 如何安装 <code>C</code> 编译器&#8230;&#8203;</a>
<ul class="sectlevel3">
<li><a href="#_在_windows_中">1.1.1. 在 <code>Windows</code> 中</a></li>
<li><a href="#_在_macos_中">1.1.2. 在 <code>MacOS</code> 中</a></li>
<li><a href="#_在_linux_中">1.1.3. 在 <code>Linux</code> 中</a></li>
<li><a href="#_主函数_main">1.1.4. 主函数 <code>main()</code></a></li>
</ul>
</li>
<li><a href="#_使用_make_进行编译">1.2. 使用 <code>make</code> 进行编译</a></li>
</ul>
</li>
<li><a href="#_进入原始模式">2. 进入原始模式</a>
<ul class="sectlevel2">
<li><a href="#_按下_q_退出">2.1. 按下 <code>q</code> 退出.</a></li>
<li><a href="#_关闭回显echo">2.2. 关闭回显(echo)</a></li>
<li><a href="#_退出时禁用原始模式">2.3. 退出时禁用原始模式</a></li>
<li><a href="#_关闭规范模式">2.4. 关闭规范模式</a></li>
<li><a href="#_显示按键">2.5. 显示按键</a></li>
<li><a href="#_关闭_ctrl_c_和_ctrl_z_信号">2.6. 关闭 <code>Ctrl-C</code> 和 <code>Ctrl-Z</code> 信号</a></li>
<li><a href="#_禁用_ctrl_s_和_ctrl_q">2.7. 禁用 <code>Ctrl-S</code> 和 <code>Ctrl-Q</code></a></li>
<li><a href="#_禁用_ctrl_v">2.8. 禁用 <code>Ctrl-V</code></a></li>
<li><a href="#_修复_ctrl_m">2.9. 修复 <code>Ctrl-M</code></a></li>
<li><a href="#_关闭所有输出处理">2.10. 关闭所有输出处理</a></li>
<li><a href="#_杂项标志位">2.11. 杂项标志位</a></li>
<li><a href="#_read_的超时设置">2.12. <code>read()</code> 的超时设置</a></li>
<li><a href="#_错误处理">2.13. 错误处理</a></li>
<li><a href="#_代码的各个部分">2.14. 代码的各个部分</a></li>
</ul>
</li>
<li><a href="#_原始输入与输出">3. 原始输入与输出</a>
<ul class="sectlevel2">
<li><a href="#_按_ctrl_q_退出">3.1. 按 <code>Ctrl-Q</code> 退出</a></li>
<li><a href="#_重构键盘输入">3.2. 重构键盘输入</a></li>
<li><a href="#_清除屏幕">3.3. 清除屏幕</a></li>
<li><a href="#_重新定位光标">3.4. 重新定位光标</a></li>
<li><a href="#_退出时清屏">3.5. 退出时清屏</a></li>
<li><a href="#_波浪线">3.6. 波浪线</a></li>
<li><a href="#_全局状态">3.7. 全局状态</a></li>
<li><a href="#_控制窗口大小的简单办法">3.8. 控制窗口大小的简单办法</a></li>
<li><a href="#_控制窗口大小的硬核方法">3.9. 控制窗口大小的硬核方法</a></li>
<li><a href="#_最后一行">3.10. 最后一行</a></li>
<li><a href="#_添加缓冲区">3.11. 添加缓冲区</a></li>
<li><a href="#_重绘时隐藏光标">3.12. 重绘时隐藏光标</a></li>
<li><a href="#_一次清除一行">3.13. 一次清除一行</a></li>
<li><a href="#_欢迎留言">3.14. 欢迎留言</a></li>
<li><a href="#_移动光标">3.15. 移动光标</a></li>
<li><a href="#_方向键">3.16. 方向键</a></li>
<li><a href="#_防止将光标移出屏幕">3.17. 防止将光标移出屏幕</a></li>
<li><a href="#_page_up_和_page_down">3.18. Page Up 和 Page Down</a></li>
<li><a href="#_home_和_end">3.19. Home 和 End</a></li>
<li><a href="#_delete">3.20. Delete</a></li>
</ul>
</li>
<li><a href="#_文本阅读器">4. 文本阅读器</a>
<ul class="sectlevel2">
<li><a href="#_行阅读器">4.1. 行阅读器</a></li>
<li><a href="#_多行">4.2. 多行</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_设置">1. 设置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>啊, 第 1 步. 你不喜欢白纸一张的全新开始吗? 然后选择你将在其上建造整个富丽堂皇的庄园的那块奇异砖块?</p>
</div>
<div class="paragraph">
<p>不幸的是, 当你构建计算机程序时, 第 1 步可能会变得&#8230;&#8203;复杂且令人沮丧. 你必须确保你的环境是为你正在使用的编程语言设置的, 并且你必须弄清楚如何在该环境中编译和运行你的程序.</p>
</div>
<div class="paragraph">
<p>幸运的是, 我们正在构建的程序不依赖于任何外部库, 因此除了 <code>C</code> 编译器和它附带的标准库之外, 你不需要任何东西(我们也将使用 <code>make</code> 程序). 要检查你是否安装了 <code>C</code> 编译器, 请尝试在命令行运行 <code>cc --version</code> (<code>cc</code> 代表 <code>C</code> 编译器). 要检查你是否有 <code>make</code> , 请尝试运行 <code>make -v</code>.</p>
</div>
<div class="sect2">
<h3 id="_如何安装_c_编译器">1.1. 如何安装 <code>C</code> 编译器&#8230;&#8203;</h3>
<div class="sect3">
<h4 id="_在_windows_中">1.1.1. 在 <code>Windows</code> 中</h4>
<div class="paragraph">
<p>你将需要在 <code>Windows</code> 中安装某种 <code>Linux</code> 环境. 这是因为我们的文本编辑器使用头文件 <code>&lt;termios.h&gt;</code> 在底层与终端交互, 这在 <code>Windows</code> 上不可用. 我建议使用 <code>Windows</code> 上的 <code>Bash</code> 或 <code>Cygwin</code> .</p>
</div>
<div class="paragraph">
<p><strong>Bash on Windows</strong>：仅适用于 <code>64</code> 位 <code>Windows 10</code> . 请参阅安装指南. 安装后, 只要想进入 <code>Linux</code> 环境就在命令行运行 <code>bash</code>. 在 <code>bash</code> 里面, 运行 <code>sudo apt-get install gcc make</code> 以安装 <code>GNU Compiler Collection</code> 和 <code>make</code> 程序. 如果 <code>sudo</code> 做任何事情都需要很长时间, 你可能需要修复 <code>/etc/hosts</code> 文件.</p>
</div>
<div class="paragraph">
<p><strong>Cygwin</strong>：从 <code>cygwin.com/install.html</code> 下载安装程序. 当安装程序要求你选择要安装的包时, 查看类别 <code>devel</code> 并选择 <code>gcc-core</code> 和 <code>make</code> 包. 要使用 <code>Cygwin</code> , 你必须运行 <code>Cygwin</code> 终端程序. 与 <code>Windows</code> 上的 <code>Bash</code> 不同, 在 <code>Cygwin</code> 中, 你的主目录与 <code>Windows</code> 主目录是分开的. 如果你将 <code>Cygwin</code> 安装到 <code>C:\cygwin64</code> , 那么你的主目录位于 <code>C:\cygwin64\home\yourname</code> . 因此, 如果你想使用 <code>Cygwin</code> 之外的文本编辑器来编写你的代码, 那就是你要保存到的地方.</p>
</div>
</div>
<div class="sect3">
<h4 id="_在_macos_中">1.1.2. 在 <code>MacOS</code> 中</h4>
<div class="paragraph">
<p>当你在终端尝试运行 <code>cc</code> 命令时, 会弹出一个窗口询问你是否要安装命令行开发人员工具. 你也可以运行 <code>xcode-select --install</code> 以弹出此窗口. 然后只需单击"安装", 它将安装 <code>C</code> 编译器和 <code>make</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_在_linux_中">1.1.3. 在 <code>Linux</code> 中</h4>
<div class="paragraph">
<p>在 <code>Ubuntu</code> 中, 它是 <code>sudo apt-get install gcc make</code>. 其他发行版也应该有 <code>gcc</code> 和 <code>make</code> 包可用.</p>
</div>
</div>
<div class="sect3">
<h4 id="_主函数_main">1.1.4. 主函数 <code>main()</code></h4>
<div class="paragraph">
<p>创建一个名为的 <code>kilo.c</code> 的新文件, 并编写一个 <code>main()</code> 函数. (<code>kilo</code> 是我们正在构建的文本编辑器的名称.)</p>
</div>
<div class="listingblock">
<div class="title">第 1 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>C</code> 中, 你必须将所有可执行代码放在函数中. <code>C</code> 中的函数 <code>main()</code> 比较特殊. 它是你运行程序时的默认起点. 当你 <code>return</code> 退出 <code>main()</code> 函数时, 程序退出并将返回的整数传递回操作系统. 返回值 <code>0</code> 表示成功.</p>
</div>
<div class="paragraph">
<p><code>C</code> 是一种编译语言. 这意味着我们需要通过 <code>C</code> 编译器来编译我们的程序, 将其转换为可执行文件. 然后我们像在命令行上运行任何其他程序一样运行该可执行文件.</p>
</div>
<div class="paragraph">
<p>要编译 <code>kilo.c</code>, 在 <code>shell</code> 中运行 <code>cc kilo.c -o kilo</code> . 如果没有错误发生, 这将生成一个名为 <code>kilo</code> 的可执行程序. <code>-o</code> 代表"输出", 并指定输出可执行文件应命名为 <code>kilo</code> .</p>
</div>
<div class="paragraph">
<p>要运行 <code>kilo</code>, 请在 <code>shell</code> 中输入 <code>./kilo</code> 并按下回车键. 该程序不打印任何输出, 但你可以通过运行 <code>echo $?</code> 检查 <code>main()</code> 函数的退出状态, 也就是返回值, 这应该打印 <code>0</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用_make_进行编译">1.2. 使用 <code>make</code> 进行编译</h3>
<div class="paragraph">
<p>每次你想重新编译时都要在终端中输入 <code>cc kilo.c -o kilo</code>, 这样很麻烦. 而 <code>make</code> 程序允许你只需要运行 <code>make</code>, 它就会编译你的程序. 你只需要提供一个 <code>Makefile</code> 文件来告诉它如何编译你的程序.</p>
</div>
<div class="paragraph">
<p>创建一个新文件 <code>Makefile</code>, <code>Makefile</code> 内容如下.</p>
</div>
<div class="listingblock">
<div class="title">第 2 步: Makefile</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="Makefile"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><pre><span></span>kilo: kilo.c
	$(CC) kilo.c -o kilo -Wall -Wextra -pedantic -std=c99
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>第 1 行表示我们要构建的是 <code>kilo</code>, 而 <code>kilo.c</code> 就是构建它所需要的. 第 2 行指定要运行的命令, 以便实际使用 <code>kilo.c</code> 来构建 <code>kilo</code>. 第 2 行的缩进, 确保使用 <strong>制表符</strong> 而不是空格. 你可以根据需要缩进 <code>C</code> 语言代码, 但是 <code>Makefile</code> 必须使用制表符.</p>
</div>
<div class="paragraph">
<p>我们在编译命令中添加了一些东西：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$(CC)</code> 是一个 <code>make</code> 会展开的变量, 默认是 <code>cc</code>.</p>
</li>
<li>
<p><code>-Wall</code> 代表"所有警告", 并让编译器在看到程序中的代码时向你发出警告, 这些代码在技术上可能没有错误, 但被认为是 <code>C</code> 语言的错误或有问题的用法, 例如在初始化变量之前使用变量.</p>
</li>
<li>
<p><code>-Wextra</code> 和 <code>-pedantic</code> 会打开更多警告. 对于本教程中的每个步骤, 如果你的程序能够编译通过, 除了在某些情况下出现"未使用的变量"警告外, 它不应产生任何警告. 如果你收到任何其他警告, 请检查以确保你的代码与该步骤中的代码完全匹配.</p>
</li>
<li>
<p><code>-std=c99</code> 指定我们正在使用的 <code>C</code> 语言标准的确切版本, 即 <code>C99</code>. <code>C99</code> 允许我们在函数内的任何地方声明变量, 而 <code>ANSI C</code> 要求所有变量都在函数或块的顶部声明.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>现在我们有了一个 <code>Makefile</code>, 试着运行 <code>make</code> 编译程序.</p>
</div>
<div class="paragraph">
<p>它可能会输出 <code>make: 'kilo' is up to date.</code>. 它可以通过查看每个文件的最后修改时间戳来判断当前版本 <code>kilo.c</code> 是否已经编译. 如果 <code>kilo</code> 在 <code>kilo.c</code> <strong>last modified</strong> 之后也 <strong>last modified</strong>了, 则 <code>make</code> 假定 <code>kilo.c</code> 已经编译, 因此它不会运行编译命令. 如果 <code>kilo.c</code> 的 <strong>last modified</strong> 是在 <code>kilo</code> 的 <strong>last modified</strong> 之后, 则 <code>make</code> 重新编译 <code>kilo.c</code>. 这对于需要编译许多不同组件的大型项目更有用, 因为当你只对一个组件的源代码进行更改时, 大多数组件不需要一遍又一遍地重新编译.</p>
</div>
<div class="paragraph">
<p>尝试将返回值更改为 <code>kilo.c</code> 以外的数字 <code>0</code> . 然后运行 <code>make</code>, 你应该会看到它已编译. 运行 <code>./kilo</code>, 并尝试 <code>echo $?</code> 查看是否获得更改后的数字. 然后改回 <code>0</code>, 重新编译, 确保它变回 <code>return 0</code>.</p>
</div>
<div class="paragraph">
<p>在本教程中的每个步骤之后, 你都需要重新编译 <code>kilo.c</code>, 看看它是否在你的代码中发现任何错误, 然后运行 <code>./kilo</code>. 我们很容易忘记重新编译而直接运行 <code>./kilo</code>, 然后发现为什么你的更改 <code>kilo.c</code> 似乎没有任何效果. 你必须重新编译才能使 <code>kilo.c</code> 中的更改反映在 <code>kilo</code> 里面.</p>
</div>
<div class="paragraph">
<p>在下一章中, 我们将努力让终端进入原始模式, 并读取用户的各个按键.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_进入原始模式">2. 进入原始模式</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>规范模式: canonical mode
.
原始模式: raw mode</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>让我们尝试读取用户的按键操作.</p>
</div>
<div class="listingblock">
<div class="title">第 3 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="hll"><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>
</span>
<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>read()</code> 和 <code>STDIN_FILENO</code> 来自 <code>&lt;unistd.h&gt;</code> . 我们要求 <code>read()</code> 从标准输入中读取 <code>1</code> 个字节到变量 <code>c</code> 中, 并一直这样做直到没有更多的字节可读. <code>read()</code> 返回它读取的字节数, 并在到达文件末尾时返回 <code>0</code>.</p>
</div>
<div class="paragraph">
<p>当运行 <code>./kilo</code> 时, 终端会连接到标准输入, 因此键盘的输入会被读取到变量 <code>c</code> 中. 但是, 默认情况下终端以 <strong>规范模式</strong> 启动, 也称为 <strong>熟化模式</strong>. 在此模式下, 键盘输入仅在用户按下 <strong>回车键</strong> 时发送到我们的程序. 这对许多程序都很有用: 它允许用户输入一行文本, 这样可以使用 <strong>退格键</strong> 来修复错误, 直到文本完全按照想要的方式输入, 最后按 <strong>回车键</strong> 将其发送到程序. 但它不适用于具有更复杂用户界面的程序, 如文本编辑器. 我们希望在每个按键输入时都对其进行处理, 以便我们可以立即做出响应.</p>
</div>
<div class="paragraph">
<p>我们想要的是 <strong>原始模式</strong>. 不幸的是, 没有简单的开关可以将终端设置为原始模式. 原始模式是通过关闭终端中的许多标志位来实现的, 我们将在本章的过程中逐渐做到这一点.</p>
</div>
<div class="paragraph">
<p>要退出上述程序, 请按 <code>Ctrl-D</code> 以告知 <code>read()</code> 它已到达文件末尾. 或者我们始终可以按 <code>Ctrl-C</code> 以发出立即终止进程的信号.</p>
</div>
<div class="sect2">
<h3 id="_按下_q_退出">2.1. 按下 <code>q</code> 退出.</h3>
<div class="paragraph">
<p>为了演示规范模式是如何工作的, 我们将让程序在读取到用户的 <code>q</code> 按键操作时退出.</p>
</div>
<div class="listingblock">
<div class="title">第 4 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">);</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>要退出程序, 必须键入一行包含 <code>q</code> 的文本, 然后按回车键. 程序将一次一个字符地快速读取文本行, 直到读取到 <code>q</code> , 此时 <code>while</code> 循环将停止且程序将退出. <code>q</code> 之后的任何字符都将在输入队列中保持未读状态, 你可能会在程序退出后看到该输入被送入你的 <code>shell</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_关闭回显echo">2.2. 关闭回显(echo)</h3>
<div class="paragraph">
<p>我们可以通过以下方式设置终端的属性.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>使用 <code>tcgetattr()</code> 将当前属性读入结构体 <code>raw</code>.</p>
</li>
<li>
<p>手动修改结构体 <code>raw</code>.</p>
</li>
<li>
<p>将修改后的结构体 <code>raw</code> 传递给 <code>tcsetattr()</code> 以写回新的终端属性. 让我们尝试以这种方式关闭 <code>ECHO</code> 功能.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">第 5 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><pre><span></span><span class="hll"><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
</span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="hll"><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>struct termios</code>, <code>tcgetattr()</code>, <code>tcsetattr()</code>, <code>ECHO</code>, <code>TCSAFLUSH</code> 都来自 <code>&lt;termios.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p><code>ECHO</code> 的功能是使你键入的每个键都打印到终端, 因此你可以看到你正在键入的内容. 这在规范模式下很有用, 但当我们试图在原始模式下仔细呈现用户界面时, 它确实会妨碍我们. 所以我们关掉它. 该程序与上一步中的程序执行相同的操作, 只是不打印你输入的内容. 如果你曾经不得不在终端输入密码, 例如在使用 <code>sudo</code> 时, 你可能会熟悉这种模式.</p>
</div>
<div class="paragraph">
<p>程序退出后, 在你的 <code>shell</code> 里面, 你可能会发现你的终端仍然没有回显你键入的内容. 别担心, 它仍然会监听你输入的内容. 只需按 <code>Ctrl-C</code> 开始新的一行输入到你的 <code>shell</code>, 然后输入 <code>reset</code> 并按回车键. 在大多数情况下, 这会将你的终端重置为正常. 如果失败, 你可以随时重新启动终端仿真器. 我们将在下一步中解决整个问题.</p>
</div>
<div class="paragraph">
<p><code>termios</code> 可以通过 <code>tcgetattr()</code> 将终端属性读入结构体 <code>raw</code>. 修改它们之后, 你可以使用 <code>tcsetattr()</code> 将它们应用到终端. <code>TCSAFLUSH</code> 参数指定何时应用更改: 在这种情况下, 它等待所有待处理的输出被写入终端, 并丢弃任何尚未读取的输入.</p>
</div>
<div class="paragraph">
<p><code>c_lflag</code> 字段用于"本地标志位". MacOS 中的 <code>&lt;termios.h&gt;</code> 有一条注释将其描述为"保存其它状态的地方". 所以也许它应该被认为是"杂项标志位". 其他标志位字段是 <code>c_iflag</code>(输入标志位), <code>c_oflag</code>(输出标志位)和 <code>c_cflag</code>(控制标志位), 所有这些我们都必须修改以启用原始模式.</p>
</div>
<div class="paragraph">
<p><code>ECHO</code> 是一个 <code>bitflag</code>, 二进制表示是: <code>00000000000000000000000000001000</code>. 我们对该值使用按位非运算符(<code>~</code>)来获取 <code>11111111111111111111111111110111</code>. 然后我们将该值与标志位字段按位与, 这会强制标志位字段中的第四位变为 <code>0</code>, 并导致每隔一位保留其当前值. 像这样翻转位在 <code>C</code> 语言中很常见.</p>
</div>
</div>
<div class="sect2">
<h3 id="_退出时禁用原始模式">2.3. 退出时禁用原始模式</h3>
<div class="paragraph">
<p>让我们善待用户, 并在我们的程序退出时恢复他们终端的原始属性. 我们使用变量 <code>orig_termios</code> 来保存终端的原始属性, 并在程序退出时用于将其应用于终端.</p>
</div>
<div class="listingblock">
<div class="title">第 6 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><pre><span></span><span class="hll"><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
</span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="hll"><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_关闭规范模式">2.4. 关闭规范模式</h3>
<div class="paragraph">
<p>有一个 <code>ICANON</code> 标志位允许我们关闭规范模式. 这意味着我们最终将逐字节读取输入, 而不是逐行读取.</p>
</div>
<div class="listingblock">
<div class="title">第 7 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ICANON</code> 来自 <code>&lt;termios.h&gt;</code>. 输入标志位(<code>c_iflag</code> 中的标志位)通常以 <code>I</code> 开始, 例如 <code>ICANON</code>. 但是,  <code>ICANON</code> 不是输入标志位, 它是 <code>c_lflag</code> 字段中的"本地"标志位. 所以这很令人困惑.</p>
</div>
<div class="paragraph">
<p>现在程序将在你按下 <code>q</code> 时立即退出.</p>
</div>
</div>
<div class="sect2">
<h3 id="_显示按键">2.5. 显示按键</h3>
<div class="paragraph">
<p>为了更好地了解原始模式下的输入是如何工作的, 让我们在 <code>read()</code> 时, 打印出我们输入的每个字节. 我们将打印每个字符的 <code>ASCII</code> 值, 以及它所代表的字符(如果它是可打印字符).</p>
</div>
<div class="listingblock">
<div class="title">第 8 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><pre><span></span><span class="hll"><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
</span><span class="hll"><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
</span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">iscntrl</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d (&#39;%c&#39;)</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>iscntrl()</code> 来自 <code>&lt;ctype.h&gt;</code>, <code>printf()</code> 来自 <code>&lt;stdio.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p><code>iscntrl()</code> 测试一个字符是否是一个控制字符. 控制字符是我们不想打印到屏幕上的不可打印字符. <code>ASCII</code> 码 <code>0-31</code> 都是控制字符, <code>127</code> 也是控制字符. <code>ASCII</code> 码 <code>32-126</code> 都是可打印的. (查看 <code>ASCII</code> 表以查看所有字符.)</p>
</div>
<div class="paragraph">
<p><code>printf()</code> 可以打印一个字节的多种表示形式. <code>%d</code> 告诉它将字节格式化为十进制数(它的 <code>ASCII</code> 码), <code>%c</code> 告诉它直接将字节作为一个字符输出.</p>
</div>
<div class="paragraph">
<p>这是一个非常有用的程序. 它向我们展示了各种按键如何转换为我们读取的字节. 大多数普通按键直接转换为它们所代表的字符. 但是试着看看当你按下 <code>方向键</code> 或者 <code>退出键</code>, 或者 <code>Page Up</code>, 或者 <code>Page Down</code>, 或者 <code>Home</code>, 或者`End`, 或者 <code>退格键</code>,  <code>删除键</code>, 或者 <code>回车键</code> 时会发生什么. 尝试使用带有 <code>Ctrl</code> 的组合键, 例如 <code>Ctrl-A</code>, <code>Ctrl-B</code> 等组合键.</p>
</div>
<div class="paragraph">
<p>你会注意到一些有趣的事情.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>方向键, <code>Page Up</code>, <code>Page Down</code>, <code>Home</code> 和 <code>End</code> 会向终端输入 <code>3</code> 或 <code>4</code> 个字节: <code>27</code>, <code>'['</code>, 然后是其他一两个字符. 这称为转义序列. 所有转义序列都以一个字节 <code>27</code> 开头. 按下 <code>退出键</code> 发送一个 <code>27</code> 字节作为输入.</p>
</li>
<li>
<p><code>退格键</code> 是字节 <code>127</code>. <code>Delete</code> 键是一个 <code>4</code> 字节的转义序列.</p>
</li>
<li>
<p><code>回车键</code> 是字节 <code>10</code>, 这是一个换行符, 也称为 <code>'\n'</code>.</p>
</li>
<li>
<p><code>Ctrl-A</code> 是 <code>1</code>, <code>Ctrl-B</code> 是 <code>2</code>, <code>Ctrl-C</code> 是&#8230;&#8203;哦, 那程序就终止了, 对吧. 但 <code>Ctrl</code> 组合键似乎确实将字母 <code>A-Z</code> 映射到了代码 <code>1-26</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>顺便说一句, 如果你碰巧按下 <code>Ctrl-S</code>, 你可能会发现你的程序似乎被冻结了. 你所做的是你已经要求你的程序停止向你发送输出. 按 <code>Ctrl-Q</code> 告诉它继续向你发送输出.</p>
</div>
<div class="paragraph">
<p>此外, 如果你按下 <code>Ctrl-Z</code>(或可能 <code>Ctrl-Y</code>), 你的程序将暂停到后台. 运行 <code>fg</code> 命令将其带回前台. (它可能会在你这样做之后立即退出, 因为 <code>read()</code> 返回 <code>-1</code> 表明发生了错误. 这发生在 MacOS 上, 而 Linux 的 <code>read()</code> 似乎能够正常恢复调用.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_关闭_ctrl_c_和_ctrl_z_信号">2.6. 关闭 <code>Ctrl-C</code> 和 <code>Ctrl-Z</code> 信号</h3>
<div class="paragraph">
<p>默认情况下, <code>Ctrl-C</code> 会向当前进程发送 <code>SIGINT</code> 信号使其终止, 并向当前进程 <code>Ctrl-Z</code> 发送 <code>SIGTSTP</code> 信号使其挂起. 让我们关闭这两个信号的发送.</p>
</div>
<div class="listingblock">
<div class="title">第 9 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ISIG</code> 来自 <code>&lt;termios.h&gt;</code>. 就像 <code>ICANON</code>, 它以 <code>I</code> 但不是输入标志位的开头.</p>
</div>
<div class="paragraph">
<p>现在按下 <code>Ctrl-C</code> 可以按字节读取 <code>3</code>, 按下 <code>Ctrl-Z</code> 也可以按字节读取 <code>26</code>.</p>
</div>
<div class="paragraph">
<p>这也会使 <code>Ctrl-Y</code> 在 MacOS 上禁用, 就像 <code>Ctrl-Z</code> 一样, 只不过它在暂停之前会等待程序读取的输入.</p>
</div>
</div>
<div class="sect2">
<h3 id="_禁用_ctrl_s_和_ctrl_q">2.7. 禁用 <code>Ctrl-S</code> 和 <code>Ctrl-Q</code></h3>
<div class="paragraph">
<p>默认情况下, <code>Ctrl-S</code> 和 <code>Ctrl-Q</code> 用来控制软件流. <code>Ctrl-S</code> 会停止将数据传输到终端, 直到你按下 <code>Ctrl-Q</code>. 这起源于很久之前, 在那时你可能想要暂停数据传输以使打印机等设备赶上来. 让我们关闭该功能.</p>
</div>
<div class="listingblock">
<div class="title">第 10 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>IXON</code> 来自 <code>&lt;termios.h&gt;</code>. <code>I</code> 这次真的代表"输入标志位"(和我们之前看到的其他标志位不同). <code>XON</code> 来自两个控制字符 <code>Ctrl-S</code> 和 <code>Ctrl-Q</code> 产生的名字: <code>XOFF</code> 负责暂停传输, <code>XON</code> 负责重启传输.</p>
</div>
<div class="paragraph">
<p>现在 <code>Ctrl-S</code> 可以按字节读取 <code>19</code>, <code>Ctrl-Q</code> 也可以按字节读取 <code>17</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_禁用_ctrl_v">2.8. 禁用 <code>Ctrl-V</code></h3>
<div class="paragraph">
<p>在一些系统上, 当你键入 <code>Ctrl-V</code> 时, 终端会等你输入另一个字符, 然后发送字符的字面量. 例如, 在我们禁用 <code>Ctrl-C</code> 前, 你可能可以按下 <code>Ctrl-V</code> 然后再按下 <code>Ctrl-C</code> 来输入字节 <code>3</code>. 我们可以使用 <code>IEXTEN</code> 标志位来关闭这个功能.</p>
</div>
<div class="paragraph">
<p>关闭 <code>IEXTEN</code> 也可以修复 MacOS 中的 <code>Ctrl-O</code> 的问题. 因为 MacOS 的终端驱动被设置为丢弃控制字符.</p>
</div>
<div class="listingblock">
<div class="title">第 11 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IEXTEN</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>IEXTEN</code> 来自 <code>&lt;termios.h&gt;</code>. 这又是一个以 <code>I</code> 开头但是属于 <code>c_lflag</code> 字段的标志位.</p>
</div>
<div class="paragraph">
<p><code>Ctrl-V</code> 现在可以被读取为字节 <code>22`了. `Ctrl-O</code> 也可以被读取为字节 <code>15</code> 了.</p>
</div>
</div>
<div class="sect2">
<h3 id="_修复_ctrl_m">2.9. 修复 <code>Ctrl-M</code></h3>
<div class="paragraph">
<p>如果你现在运行程序, 并在按住 <code>Ctrl</code> 的同时按一遍整个字母表, 你应该会看到除了 <code>M</code> 之外的所有字母. <code>Ctrl-M</code> 很奇怪: 当我们期望它被读入为 <code>13</code> 时, 它被读入为 <code>10</code>. 因为它是字母表中的第 <code>13</code> 个字母, 并且 <code>Ctrl-J</code> 已经产生了一个 <code>10</code>. 什么按键还产生 <code>10</code>? 回车键也会产生 <code>10</code>.</p>
</div>
<div class="paragraph">
<p>事实证明, 终端正在帮助将用户输入的任何回车符(<code>13</code>, <code>\r</code>)转换为换行符 (<code>10</code>, <code>\n</code>). 让我们关闭这个功能.</p>
</div>
<div class="listingblock">
<div class="title">第 12 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ICRNL</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IEXTEN</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ICRNL</code> 来自 <code>&lt;termios.h&gt;</code>. <code>I</code> 代表"输入标志", <code>CR</code> 代表"回车", <code>NL</code> 代表"换行".</p>
</div>
<div class="paragraph">
<p>现在 <code>Ctrl-M</code> 读入为字节 <code>13</code>(回车), 回车键也读入为 <code>13</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_关闭所有输出处理">2.10. 关闭所有输出处理</h3>
<div class="paragraph">
<p>事实证明, 终端在输出端做了类似的翻译. 它将我们打印的每个换行符(<code>"\n"</code>)转换为回车符后跟换行符(<code>"\r\n"</code>). 终端需要这两个字符才能开始新的一行文本. 回车将光标移回到当前行的开头, 换行符将光标向下移动一行, 必要时滚动屏幕. (这两种截然不同的操作起源于打字机和电传打字机时代.)</p>
</div>
<div class="paragraph">
<p>我们将通过关闭 <code>OPOST</code> 标志来关闭所有输出处理功能. 实际上, <code>"\n"</code> 到 <code>"\r\n"</code> 的翻译可能是唯一默认打开的输出处理功能.</p>
</div>
<div class="listingblock">
<div class="title">第 13 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ICRNL</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_oflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">OPOST</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IEXTEN</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>OPOST</code> 来自 <code>&lt;termios.h&gt;</code>. <code>O</code> 意味着它是一个输出标志, 我假设 <code>POST</code> 代表"输出后的处理".</p>
</div>
<div class="paragraph">
<p>如果你现在运行程序, 你会看到我们正在打印的换行符只是将光标向下移动, 而不是向屏幕左侧移动. 为了解决这个问题, 让我们在语句中添加回车符 <code>printf()</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 14 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">iscntrl</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d (&#39;%c&#39;)</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从现在开始, 每当我们想开始新的一行时, 我们都必须写出完整的内容 <code>"\r\n"</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_杂项标志位">2.11. 杂项标志位</h3>
<div class="paragraph">
<p>让我们关闭更多的标志位.</p>
</div>
<div class="listingblock">
<div class="title">第 15 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">BRKINT</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICRNL</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">INPCK</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISTRIP</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_oflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">OPOST</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cflag</span><span class="tok-w"> </span><span class="tok-o">|=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">CS8</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IEXTEN</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>BRKINT</code>, <code>INPCK</code>, <code>ISTRIP</code>, <code>CS8</code> 都来自 <code>&lt;termios.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p>此步骤可能不会对你产生任何可观察到的影响, 因为这些标志位要么已经关闭, 要么实际上并不适用于现代终端仿真器. 但曾几何时, (有人)认为关闭它们是启用"原始模式"的一部分, 因此我们在程序中继承了传统.</p>
</div>
<div class="paragraph">
<p>据我所知:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BRKINT</code> 打开时, 中断条件将导致向程序发送信号 <code>SIGINT</code>, 如同按下 <code>Ctrl-C</code>.</p>
</li>
<li>
<p><code>INPCK</code> 启用奇偶校验, 这似乎不适用于现代终端仿真器.</p>
</li>
<li>
<p><code>ISTRIP</code> 导致每个输入字节的第 <code>8</code> 位被剥离, 这意味着它将把它设置为 <code>0</code>. 这可能已经关闭.</p>
</li>
<li>
<p><code>CS8</code> 不是标志, 它是具有多个位的位掩码, 我们使用按位或(<code>|</code>)运算符设置它, 这与我们要关闭的所有标志不同. 它将字符大小(<code>CS</code>)设置为每字节 <code>8</code> 位. 在我的系统上, 它已经设置好了.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_read_的超时设置">2.12. <code>read()</code> 的超时设置</h3>
<div class="paragraph">
<p>目前, <code>read()</code> 在返回之前将无限期地等待来自键盘的输入. 如果我们想在等待用户输入时在屏幕上做一些动画怎么办? 我们可以设置超时, <code>read()</code> 如果在一定时间内没有获得任何输入, 则返回.</p>
</div>
<div class="listingblock">
<div class="title">第 16 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">BRKINT</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICRNL</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">INPCK</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISTRIP</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_oflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">OPOST</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cflag</span><span class="tok-w"> </span><span class="tok-o">|=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">CS8</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IEXTEN</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cc</span><span class="tok-p">[</span><span class="tok-n">VMIN</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cc</span><span class="tok-p">[</span><span class="tok-n">VTIME</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="hll"><span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">iscntrl</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d (&#39;%c&#39;)</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>VMIN</code> 和 <code>VTIME</code> 来自 <code>&lt;termios.h&gt;</code>. 它们是字段 <code>c_cc</code> 的索引, 代表"控制字符", 一个控制各种终端设置的字节数组.</p>
</div>
<div class="paragraph">
<p><code>VMIN</code> 设置 <code>read()</code> 返回前所需的最小输入字节数. 我们将其设置为 <code>0</code> 以便 <code>read()</code> 在有任何输入要读取时立即返回. <code>VTIME</code> 设置 <code>read()</code> 返回前等待的最长时间. 它以十分之一秒为单位, 因此我们将其设置为 <code>1/10</code> 秒, 即 <code>100</code> 毫秒. 如果 <code>read()</code> 超时, 它将返回 <code>0</code>, 这是有道理的, 因为它通常的返回值是读取的字节数.</p>
</div>
<div class="paragraph">
<p>当你运行该程序时, 你可以看到 <code>read()</code> 超时的频率. 如果你不提供任何输入, 则 <code>read()</code> 返回时不设置 <code>c</code> 变量, 它会保留 <code>0</code> 值, 因此你会看到 <code>0</code> 秒被打印出来了. 如果你打字速度非常快, 你可以看到在每次按键后 <code>read()</code> 立即返回, 所以你不会每十分之一秒只能读取一次按键.</p>
</div>
<div class="paragraph">
<p>如果你使用 <strong>Windows</strong> 上的 <code>Bash</code> , 你可能会看到它 <code>read()</code> 仍然会为了输入而阻塞. 它似乎并不关心 <code>VTIME</code> 的值. 幸运的是, 这不会对我们的文本编辑器产生太大影响, 因为无论如何我们基本上都会阻塞输入.</p>
</div>
</div>
<div class="sect2">
<h3 id="_错误处理">2.13. 错误处理</h3>
<div class="paragraph">
<p>现在, <code>enableRawMode()</code> 让我们完全进入原始模式. 是时候通过添加一些错误处理来清理代码了.</p>
</div>
<div class="paragraph">
<p>首先, 我们将添加一个 <code>die()</code> 打印错误消息并退出程序的函数.</p>
</div>
<div class="listingblock">
<div class="title">第 17 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="hll"><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">perror</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>perror()</code> 来自 <code>&lt;stdio.h&gt;</code>, <code>exit()</code> 来自 <code>&lt;stdlib.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p>大多数执行失败的 <code>C</code> 库函数将设置 <code>errno</code> 这个全局变量来指示错误是什么. <code>perror()</code> 查看 <code>errno</code> 全局变量并为其打印一条描述性错误消息. 它还会在打印错误消息之前打印提供给它的字符串, 这意味着提供有关代码的哪一部分导致错误的上下文.</p>
</div>
<div class="paragraph">
<p>打印出错误消息后, 我们退出程序, 退出状态为 <code>1</code>, 表示失败(与任何非零值一样).</p>
</div>
<div class="paragraph">
<p>让我们检查我们的每个库调用是否失败, 并在失败时调用 <code>die()</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 18 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="hll"><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;errno.h&gt;</span><span class="tok-cp"></span>
</span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;tcsetattr&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">orig_termios</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;tcgetattr&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">BRKINT</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICRNL</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">INPCK</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISTRIP</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_oflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">OPOST</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cflag</span><span class="tok-w"> </span><span class="tok-o">|=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">CS8</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IEXTEN</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cc</span><span class="tok-p">[</span><span class="tok-n">VMIN</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cc</span><span class="tok-p">[</span><span class="tok-n">VTIME</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;tcsetattr&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">iscntrl</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d (&#39;%c&#39;)</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>errno</code> 和 <code>EAGAIN</code> 来自 <code>&lt;errno.h&gt;</code></p>
</div>
<div class="paragraph">
<p><code>tcsetattr()</code>, <code>tcgetattr()</code>, 和 <code>read()</code> 在失败时都会返回 <code>-1</code> , 并设置 <code>errno</code> 值来指示错误.</p>
</div>
<div class="paragraph">
<p>在 <strong>Cygwin</strong> 中, 当 <code>read()</code> 超时时它返回 <code>-1</code>, 也就是值为 <code>EAGAIN</code> 的 <code>errno</code>, 而不是像它应该的那样返回 <code>0</code>. 为了使其在 <strong>Cygwin</strong> 中工作, 我们不会将其视为 <code>EAGAIN</code> 错误.</p>
</div>
<div class="paragraph">
<p>一个让 <code>tcgetattr()</code> 执行失败的简单方法是: 给你的程序一个文本文件或一个管道作为标准输入而不是你的终端作为标准输入. 要给它一个文件作为标准输入, 运行 <code>./kilo &lt; kilo.c</code>. 要给它一个管道作为标准输入, 运行 <code>echo test | ./kilo</code>. 两者都应该导致 <code>tcgetattr()</code> 输出相同的错误, 例如 <code>Inappropriate ioctl for device</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_代码的各个部分">2.14. 代码的各个部分</h3>
<div class="paragraph">
<p>本章关于进入原始模式的内容到此结束. 我们现在要做的最后一件事是将我们的代码分成几个部分. 这将使这些差异更短, 因为差异中未更改的每个部分都将折叠成一行.</p>
</div>
<div class="listingblock">
<div class="title">第 19 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><pre><span></span><span class="hll"><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;errno.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="hll"><span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
</span>
<span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="hll"><span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
</span>
<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="hll"><span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</span>
<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在下一章中, 我们将做一些更底层的终端输入/输出处理, 并使用它来绘制到屏幕并允许用户移动光标.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_原始输入与输出">3. 原始输入与输出</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_按_ctrl_q_退出">3.1. 按 <code>Ctrl-Q</code> 退出</h3>
<div class="paragraph">
<p>上一章我们看到 <code>Ctrl</code> 键与字母键组合似乎映射到字节 <code>1-26</code>. 我们可以使用它来检测 <code>Ctrl</code> 组合键并将它们映射到我们编辑器中的不同操作. 我们从将 <code>Ctrl-Q</code> 映射到退出操作开始.</p>
</div>
<div class="listingblock">
<div class="title">第 20 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;errno.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="hll"><span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span>
</span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">iscntrl</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d (&#39;%c&#39;)</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>宏定义 <code>CTRL_KEY</code> 将字符的值和二进制 <code>00011111</code> 进行按位与运算. (在 <code>C</code> 语言中, 我们通常使用十六进制指定位掩码, 因为 <code>C</code> 语言没有二进制字面量, 一旦你习惯了十六进制, 会觉得十六进制更加简洁和可读.) 换句话说, 它将字符的高 <code>3</code> 位设置为 <code>0</code>. 这反映了 <code>Ctrl</code> 键在终端中的作用: 它从你在 <code>Ctrl</code> 后面按下的任何键中剥离位 <code>5</code> 和 <code>6</code>, 并发送它. (按照惯例, 位编号从 <code>0</code> 开始.) <code>ASCII</code> 字符集似乎是故意这样设计的. (它也有类似的设计, 因此你可以设置和清除位 <code>5</code> 以在小写和大写之间切换.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_重构键盘输入">3.2. 重构键盘输入</h3>
<div class="paragraph">
<p>让我们创建一个用于低级按键读取的函数, 以及另一个用于将按键映射到编辑器操作的函数. 此时我们也将停止打印按键.</p>
</div>
<div class="listingblock">
<div class="title">第 21 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">nread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
<span class="hll">
</span><span class="hll"><span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-o">:</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-p">}</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</span>
<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorProcessKeypress</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="hll"><span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>editorReadKey()</code> 的工作是等待一次按键, 然后返回. 稍后, 我们将扩展此函数以处理转义序列, 这涉及读取表示单个按键的多个字节, 就像方向键的情况一样.</p>
</div>
<div class="paragraph">
<p><code>editorProcessKeypress()</code> 等待按键, 然后处理它. 稍后, 它将各种 <code>Ctrl</code> 组合键和其他特殊键映射到不同的编辑器功能, 并将任何字母数字和其他可打印键的字符插入到正在编辑的文本中.</p>
</div>
<div class="paragraph">
<p>请注意, <code>editorReadKey()</code> 属于 <code>/<strong>* terminal </strong><strong>/</code> 部分是因为它处理底层终端输入, 而 <code>editorProcessKeypress()</code> 属于新的 <code>/<strong></strong> input </strong>*/</code> 部分是因为它处理将键映射到更高级别的编辑器功能.</p>
</div>
<div class="paragraph">
<p>现在我们已经大大简化了 <code>main()</code>, 我们将尽量保持这种状态.</p>
</div>
</div>
<div class="sect2">
<h3 id="_清除屏幕">3.3. 清除屏幕</h3>
<div class="paragraph">
<p>我们将在每次按键后将编辑器的用户界面渲染到屏幕上. 让我们从清除屏幕开始.</p>
</div>
<div class="listingblock">
<div class="title">第 22 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorRefreshScreen</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorProcessKeypress</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>write()</code> 和 <code>STDOUT_FILENO</code> 来自 <code>&lt;unistd.h&gt;</code> .</p>
</div>
<div class="paragraph">
<p><code>write()</code> 调用中的 <code>4</code> 表示我们正在将 <code>4</code> 个字节写出到终端. 第一个字节是转义字符 <code>\x1b</code>, 或者十进制 <code>27</code>. (试着记住 <code>\x1b</code>, 我们会经常使用它. )其他三个字节是 <code>[2J</code>.</p>
</div>
<div class="paragraph">
<p>我们正在向终端写入一个转义序列. 转义序列始终以转义字符(<code>27</code>)开头, 后跟一个 <code>[</code> 字符. 转义序列指示终端执行各种文本格式化任务, 例如为文本着色、四处移动光标和清除部分屏幕.</p>
</div>
<div class="paragraph">
<p>我们正在使用 <code>J</code> 命令来清除屏幕. 转义序列命令接收的参数位于命令之前. 在这种情况下, 参数是 <code>2</code>, 表示清除整个屏幕. <code>&lt;esc&gt;[1J</code> 会清除屏幕直到光标所在的位置, 命令 <code>&lt;esc&gt;[0J</code> 会清除从光标到屏幕末尾的屏幕. 此外, <code>0</code> 是 <code>J</code> 的默认参数, 因此命令 <code>&lt;esc&gt;[J</code> 本身也会清除从光标到末尾的屏幕.</p>
</div>
<div class="paragraph">
<p>对于我们的文本编辑器, 我们将主要使用 <code>VT100</code> 转义序列, 现代终端仿真器广泛支持它. 有关每个转义序列的完整文档, 请参阅 <code>VT100</code> 用户指南.</p>
</div>
<div class="paragraph">
<p>如果我们想要支持最大数量的终端, 我们可以使用 <code>ncurses</code> 库, 它使用 <code>terminfo</code> 数据库来确定终端的功能以及该特定终端使用的转义序列.</p>
</div>
</div>
<div class="sect2">
<h3 id="_重新定位光标">3.4. 重新定位光标</h3>
<div class="paragraph">
<p>你可能会注意到 <code>&lt;esc&gt;[2J</code> 命令将光标留在了屏幕底部. 让我们将它重新定位在左上角, 以便我们准备好从上到下绘制编辑器界面.</p>
</div>
<div class="listingblock">
<div class="title">第 23 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这个转义序列只有 <code>3</code> 字节长, 并使用 <code>H</code> 命令定位光标. <code>H</code> 命令实际上有两个参数: 行号和光标所在的列号. 所以如果你有一个 <code>80 x 24</code> 大小的终端并且你希望光标在屏幕中央, 你可以使用命令 <code>&lt;esc&gt;[12;40H</code>. (多个参数由字符 <code>;</code> 分隔. )<code>H`的这两个默认参数恰好是 `1</code>, 因此我们可以将两个参数都省略, 它将光标定位在第一行和第一列, 就好像我们已经发送了命令 <code>&lt;esc&gt;[1;1H</code> 一样. (行和列的编号从 <code>1</code> 开始, 而不是 <code>0</code>. )</p>
</div>
</div>
<div class="sect2">
<h3 id="_退出时清屏">3.5. 退出时清屏</h3>
<div class="paragraph">
<p>让我们在程序退出时清空屏幕并重新定位光标. 如果在渲染屏幕的过程中发生错误, 我们不希望屏幕上留下一堆垃圾, 我们也不希望光标恰好在那个点的任何地方打印错误.</p>
</div>
<div class="listingblock">
<div class="title">第 24 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">perror</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">      </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们的程序有两个退出的地方, 我们希望在调用 <code>die()</code> 和用户按下 <code>Ctrl-Q</code> 退出时清除屏幕.</p>
</div>
<div class="paragraph">
<p>在程序退出时我们可以使用 <code>atexit()</code> 来清除屏幕, 但是 <code>die()</code> 打印出来的错误消息会在打印后立即被擦除.</p>
</div>
</div>
<div class="sect2">
<h3 id="_波浪线">3.6. 波浪线</h3>
<div class="paragraph">
<p>是时候开始画画了. 让我们在屏幕的左侧绘制一列波浪号(<code>~</code>), 就像 vim 所做的那样. 在我们的文本编辑器中, 我们将在正在编辑的文件末尾之后的任何行的开头绘制波浪号</p>
</div>
<div class="listingblock">
<div class="title">第 25 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-mi">24</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">editorDrawRows</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>editorDrawRows()</code> 将处理绘制正在编辑的文本缓冲区的每一行. 现在它在每一行中绘制波浪号, 这意味着该行不是文件的一部分并且不能包含任何文本.</p>
</div>
<div class="paragraph">
<p>我们还不知道终端的大小, 所以我们不知道要绘制多少行. 现在我们只绘制 <code>24</code> 行.</p>
</div>
<div class="paragraph">
<p>完成绘图后, 我们执行另一个 <code>&lt;esc&gt;[H</code> 转义序列以将光标重新定位回左上角.</p>
</div>
</div>
<div class="sect2">
<h3 id="_全局状态">3.7. 全局状态</h3>
<div class="paragraph">
<p>我们的下一个目标是获取终端的大小, 以便我们知道在 <code>editorDrawRows()</code> 要绘制多少行. 但首先, 让我们设置一个包含编辑器状态的全局结构体, 我们将使用它来存储终端的宽度和高度. 现在, 让我们把整个 <code>orig_termios</code> 放入结构体中.</p>
</div>
<div class="listingblock">
<div class="title">第 26 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">orig_termios</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;tcsetattr&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">tcgetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">orig_termios</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;tcgetattr&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">atexit</span><span class="tok-p">(</span><span class="tok-n">disableRawMode</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_iflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">BRKINT</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICRNL</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">INPCK</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISTRIP</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IXON</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_oflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">OPOST</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cflag</span><span class="tok-w"> </span><span class="tok-o">|=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">CS8</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_lflag</span><span class="tok-w"> </span><span class="tok-o">&amp;=</span><span class="tok-w"> </span><span class="tok-o">~</span><span class="tok-p">(</span><span class="tok-n">ECHO</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ICANON</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">IEXTEN</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">ISIG</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cc</span><span class="tok-p">[</span><span class="tok-n">VMIN</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">raw</span><span class="tok-p">.</span><span class="tok-n">c_cc</span><span class="tok-p">[</span><span class="tok-n">VTIME</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">tcsetattr</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TCSAFLUSH</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">raw</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;tcsetattr&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>包含编辑器状态的全局变量名为 <code>E</code> . 我们必须用 <code>E.orig_termios</code> 替换所有出现 <code>orig_termios</code> 的地方.</p>
</div>
</div>
<div class="sect2">
<h3 id="_控制窗口大小的简单办法">3.8. 控制窗口大小的简单办法</h3>
<div class="paragraph">
<p>在大多数系统上, 你应该能够通过简单地调用 <code>ioctl()</code> 并传入参数 <code>TIOCGWINSZ</code> 来获取终端的大小. (据我所知, 它代表 <strong>T</strong>erminal <strong>IOC</strong>tl(它本身代表 <strong>I</strong>nput/<strong>O</strong>utput <strong>C</strong>on<strong>t</strong>ro<strong>l</strong> ) <strong>G</strong>et<strong>WIN</strong>dow<strong>S</strong>i<strong>Z</strong>e. )</p>
</div>
<div class="listingblock">
<div class="title">第 27 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;errno.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;sys/ioctl.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">winsize</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">ioctl</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TIOCGWINSZ</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">ws</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_row</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ioctl()</code>, <code>TIOCGWINSZ</code> 和 <code>struct winsize</code> 来自 <code>&lt;sys/ioctl.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p>成功时, <code>ioctl()</code> 会将终端的列数和行数放入给定的 <code>winsize</code> 结构体中. 失败时 <code>ioctl()</code> 返回 <code>-1</code>. 我们还检查以确保它返回的值不是 <code>0</code>, 因为显然这可能是错误的结果. 如果 <code>ioctl()</code> 以任何一种方式失败, 我们都会通过 <code>getWindowSize()</code> 返回 <code>-1</code> 来报告失败. 如果成功, 我们通过设置传递给函数的 <code>int</code> 引用将值传回. (这是在 C 中让函数返回多个值的常用方法. 它还允许你使用返回值来指示成功或失败. )</p>
</div>
<div class="paragraph">
<p>现在让我们将 <code>screenrows</code> 和 <code>screencols</code> 添加到我们的全局编辑器状态, 并调用 <code>getWindowSize()</code> 以填充这些值.</p>
</div>
<div class="listingblock">
<div class="title">第 28 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">initEditor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">getWindowSize</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;getWindowSize&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">initEditor</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorRefreshScreen</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorProcessKeypress</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>initEditor()</code> 的工作将是初始化 <code>E</code> 结构体中的所有字段.</p>
</div>
<div class="paragraph">
<p>现在我们准备好在屏幕上显示适当数量的波浪号.</p>
</div>
<div class="listingblock">
<div class="title">第 29 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_控制窗口大小的硬核方法">3.9. 控制窗口大小的硬核方法</h3>
<div class="paragraph">
<p><code>ioctl()</code> 不能保证能够在所有系统上请求窗口大小, 因此我们将提供一种获取窗口大小的备用方法.</p>
</div>
<div class="paragraph">
<p>我们的策略是将光标定位在屏幕的右下角, 然后使用转义序列查询光标的位置. 这告诉我们屏幕上肯定有多少行和多少列.</p>
</div>
<div class="paragraph">
<p>让我们从将光标移动到右下角开始.</p>
</div>
<div class="listingblock">
<div class="title">第 30 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">winsize</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">ioctl</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TIOCGWINSZ</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">ws</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[999C</span><span class="tok-se">\x1b</span><span class="tok-s">[999B&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_row</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>正如你可能从代码中了解到的那样, 没有简单的"将光标移动到右下角"命令.</p>
</div>
<div class="paragraph">
<p>我们一个接一个地发送两个转义序列. 命令 <code>C</code> 将光标向右移动, 命令 <code>B</code> 将光标向下移动. 参数表示将其向右或向下移动多少. 我们使用一个非常大的值 <code>999</code>, 它应该确保光标到达屏幕的右边缘和下边缘.</p>
</div>
<div class="paragraph">
<p>命令 <code>C</code> 和 <code>B</code> 专门用于阻止光标越过屏幕边缘. 我们不使用 <code>&lt;esc&gt;[999;999H</code> 命令的原因是文档没有指定当你尝试将光标移出屏幕时会发生什么.</p>
</div>
<div class="paragraph">
<p>请注意, 我们暂时将 <code>1 ||</code> 放在 <code>if</code> 的条件的最前面, 以便我们可以测试我们正在开发的这个回退分支.</p>
</div>
<div class="paragraph">
<p>因为此时, 我们调用 <code>getWindowSize()</code> 时总是返回(意味着发生错误) <code>-1</code>, 所以我们调用 <code>editorReadKey()</code> 以便我们可以在程序调用 <code>die()</code> 和清除屏幕之前观察转义序列的结果. 当你运行程序时, 你应该看到光标位于屏幕的右下角, 然后当你按下一个键时, 你会看到在 <code>die()</code> 清除屏幕后打印的错误消息.</p>
</div>
<div class="paragraph">
<p>接下来我们需要获取光标位置. 命令 <code>n</code> 可用于查询终端的状态信息. 我们可以给它一个参数 <code>6</code> 来询问光标位置. 然后我们可以从标准输入中读取回复. 让我们打印出标准输入中的每个字符, 看看回复是什么样子的.</p>
</div>
<div class="listingblock">
<div class="title">第 31 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[6n&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">iscntrl</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;%d (&#39;%c&#39;)</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">winsize</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">ioctl</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TIOCGWINSZ</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">ws</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[999C</span><span class="tok-se">\x1b</span><span class="tok-s">[999B&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">getCursorPosition</span><span class="tok-p">(</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">cols</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_row</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>回复是一个转义序列! 它是一个转义字符(<code>27</code>), 后跟一个 <code>[</code> 字符, 然后是实际的响应: <code>24;80R</code>, 或类似的.</p>
</div>
<div class="paragraph">
<p>和以前一样, 我们插入了一个临时调用 <code>editorReadKey()</code> 可以让我们在退出时清除屏幕之前观察我们的调试输出.</p>
</div>
<div class="paragraph">
<p>(注意: 如果你在 <strong>Windows</strong> 上使用 <code>Bash</code>, <code>read()</code> 不会超时, 所以你会陷入无限循环. 你必须在外部终止进程, 或者退出并重新打开命令提示符窗口.)</p>
</div>
<div class="paragraph">
<p>我们将不得不解析这个响应. 但首先, 让我们将其读入缓冲区. 我们将继续读取字符, 直到我们到达字符 <code>R</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 32 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">32</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[6n&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;R&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&amp;buf[1]: &#39;%s&#39;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>当我们打印缓冲区时, 我们不想打印字符 <code>'\x1b'</code>, 因为终端会将其解释为转义序列而不会显示它. 所以我们通过传递 <code>&amp;buf[1]</code> 给 <code>printf()</code> 来跳过 <code>buf</code> 的第一个字符. <code>printf()</code> 期望字符串以一个字节 <code>0</code> 结尾, 所以我们需要确保为 <code>buf</code> 分配 <code>'\0'</code>.</p>
</div>
<div class="paragraph">
<p>如果你运行该程序, 你会看到我们的 <code>buf</code> 以 <code>&lt;esc&gt;[24;80</code> 的形式显示. 让我们使用 <code>sscanf()</code> 方法解析其中的两个数字:</p>
</div>
<div class="listingblock">
<div class="title">第 33 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">32</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">unsigned</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[6n&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;R&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-sc">&#39;[&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">sscanf</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-s">&quot;%d;%d&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>sscanf()</code> 来自 <code>&lt;stdio.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p>首先, 我们确保它以转义序列响应. 然后我们传递给 <code>sscanf()</code> 一个指向 <code>buf</code> 的第三个字符的指针, 跳过 <code>'\x1b'</code> 和 <code>'['</code> 字符. 所以我们将字符串 <code>24;80</code> 传递给 <code>sscanf()</code>. 我们还向它传递了一个字符串 <code>%d;%d</code>, 该字符串告诉它解析两个由 <code>;</code> 分隔的整数, 并将值放入 <code>rows</code> 和 <code>cols</code> 变量中.</p>
</div>
<div class="paragraph">
<p>我们获取窗口大小的备用方法现已完成. 你应该会看到 <code>editorDrawRows()</code> 针对你的终端高度打印出正确数量的波浪号.</p>
</div>
<div class="paragraph">
<p>现在我们知道这行得通了, 让我们暂时删除我们放入 <code>if</code> 的条件 <code>1 ||</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 34 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">winsize</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">ioctl</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">TIOCGWINSZ</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">ws</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[999C</span><span class="tok-se">\x1b</span><span class="tok-s">[999B&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">12</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">getCursorPosition</span><span class="tok-p">(</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">cols</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_col</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ws</span><span class="tok-p">.</span><span class="tok-n">ws_row</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_最后一行">3.10. 最后一行</h3>
<div class="paragraph">
<p>也许你注意到屏幕的最后一行似乎没有波浪号. 那是因为我们代码中的一个小错误. 当我们打印最后一个波浪号时, 我们会像在任何其他行上一样打印一个 <code>"\r\n"</code>, 但这会导致终端滚动以便为新的空白行腾出空间. 当我们打印 <code>"\r\n"</code> 时, 让我们把最后一行作为一个例外.</p>
</div>
<div class="listingblock">
<div class="title">第 35 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_添加缓冲区">3.11. 添加缓冲区</h3>
<div class="paragraph">
<p>每次刷新屏幕时都调用一大堆 <code>write()</code> 并不是一个好主意. 最好做一个大的 <code>write()</code>, 以确保立即刷新整个屏幕. 否则, 在一堆 <code>write()</code> 调用之间可能会有不可预测的小停顿, 这会导致恼人的闪烁效果.</p>
</div>
<div class="paragraph">
<p>我们想用将字符串追加到缓冲区的代码替换我们所有的 <code>write()</code> 调用, 然后在最后调用 <code>write()</code> 将缓冲区输出. 不幸的是, C 没有动态字符串, 因此我们将构建一种只支持追加操作的动态字符串类型.</p>
</div>
<div class="paragraph">
<p>让我们开始创建一个新 <code>/<strong>* append buffer </strong>*/</code> 部分, 并在其下定义结构体 <code>abuf</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 36 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-cp">#define ABUF_INIT {NULL, 0}</span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>追加缓冲区由指向内存中缓冲区的指针和缓冲区长度组成. 我们定义一个代表空缓冲区的常量 <code>ABUF_INIT</code>. 这充当我们 <code>abuf</code> 类型的构造函数.</p>
</div>
<div class="paragraph">
<p>接下来, 让我们定义 <code>abAppend()</code> 操作, 以及 <code>abFree()</code> 析构函数.</p>
</div>
<div class="listingblock">
<div class="title">第 37 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;errno.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;string.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;sys/ioctl.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-cp">#define ABUF_INIT {NULL, 0}</span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">abAppend</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">new</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">realloc</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-o">-&gt;</span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-o">-&gt;</span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">new</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-nb">NULL</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">new</span><span class="tok-p">[</span><span class="tok-n">ab</span><span class="tok-o">-&gt;</span><span class="tok-n">len</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ab</span><span class="tok-o">-&gt;</span><span class="tok-n">b</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">new</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ab</span><span class="tok-o">-&gt;</span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">abFree</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-o">-&gt;</span><span class="tok-n">b</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>realloc()</code> 和 <code>free()</code> 来自 <code>&lt;stdlib.h&gt;</code>. <code>memcpy()</code> 来自 <code>&lt;string.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p>要将字符串 <code>s</code> 附加到 <code>abuf</code>, 我们要做的第一件事是确保分配足够的内存来保存新字符串. 我们要求 <code>realloc()</code> 给我们一个内存块, 它是当前字符串的大小加上我们要追加的字符串的大小. <code>realloc()</code> 将扩展我们已经分配的内存块的大小, 或者它将负责 <code>free()</code> 当前内存块并在其他地方分配一个足够大的新内存块来容纳我们的新字符串.</p>
</div>
<div class="paragraph">
<p>然后我们使用 <code>memcpy()</code> 将字符串 <code>s</code> 复制到缓冲区中当前数据的结尾处, 并将 <code>abuf</code> 的指针和长度更新为新值.</p>
</div>
<div class="paragraph">
<p><code>abFree()</code> 是一个析构函数, 用于释放 <code>abuf</code> 所使用的动态内存.</p>
</div>
<div class="paragraph">
<p>好的, 我们的 <code>abuf</code> 类型已经可以使用了.</p>
</div>
<div class="listingblock">
<div class="title">第 38 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ABUF_INIT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">editorDrawRows</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abFree</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>editorRefreshScreen()</code> 中, 我们首先初始化一个新的 <code>abuf</code> 结构体实例 <code>ab</code>, 通过将 <code>ABUF_INIT</code> 赋值给 <code>ab</code>. 然后将每一个 <code>write(STDOUT_FILENO, &#8230;&#8203;)</code> 替换为 <code>abAppend(&amp;ab, &#8230;&#8203;)</code>. 我们将 <code>ab</code> 传递给 <code>editorDrawRows()</code>, 所以它也可以使用 <code>abAppend()</code>. 最后, 我们调用 <code>write()</code> 将缓冲区中的内容写入标准输出, 然后释放 <code>abuf</code> 使用的内存.</p>
</div>
</div>
<div class="sect2">
<h3 id="_重绘时隐藏光标">3.12. 重绘时隐藏光标</h3>
<div class="paragraph">
<p>我们现在要处理的令人讨厌的闪烁效果还有另一个可能的来源. 当终端绘制到屏幕上时, 光标可能会在屏幕中间某处显示一瞬间. 为了确保不会发生这种情况, 让我们在刷新屏幕之前隐藏光标, 并在刷新完成后立即再次显示它.</p>
</div>
<div class="listingblock">
<div class="title">第 39 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ABUF_INIT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25l&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">editorDrawRows</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25h&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abFree</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们使用转义序列告诉终端隐藏和显示光标. <code>h</code> 命令和 <code>l</code> 命令(设置模式、重置模式)用于打开和关闭各种终端功能或"模式". VT100 用户指南没有记录我们在上面使用的参数 <code>?25</code>. 看来光标隐藏/显示功能出现在后来的 VT 模型中. 所以一些终端可能不支持隐藏/显示光标, 但如果它们不支持, 那么它们将忽略那些转义序列, 这在这种情况下没什么大不了的.</p>
</div>
</div>
<div class="sect2">
<h3 id="_一次清除一行">3.13. 一次清除一行</h3>
<div class="paragraph">
<p>与其在每次刷新之前清除整个屏幕, 不如在重绘时清除每一行似乎更理想. 让我们删除 <code>&lt;esc&gt;[2J</code> (清除整个屏幕)转义序列, 而是在我们绘制的每一行的末尾放置一个转义序列 <code>&lt;esc&gt;[K</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 40 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[K&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ABUF_INIT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25l&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">editorDrawRows</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25h&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abFree</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>命令 <code>K</code> 擦除当前行的一部分. 它的参数类似于 <code>J</code> 命令的参数: <code>2</code> 擦除整行, <code>1</code> 擦除光标左侧的行部分, <code>0</code> 擦除光标右侧的行部分. <code>0</code> 是默认参数, 这就是我们想要的, 所以我们省去了参数, 只使用 <code>&lt;esc&gt;[K</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_欢迎留言">3.14. 欢迎留言</h3>
<div class="paragraph">
<p>也许是时候显示欢迎信息了. 让我们在屏幕下方三分之一处显示编辑器的名称和版本号.</p>
</div>
<div class="listingblock">
<div class="title">第 41 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>

<span class="tok-cp">#define KILO_VERSION &quot;0.0.1&quot;</span>

<span class="tok-cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span>

<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">[</span><span class="tok-mi">80</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snprintf</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">),</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-s">&quot;Kilo editor -- version %s&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">KILO_VERSION</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[K&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>snprintf()</code> 来自 <code>&lt;stdio.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p>我们使用 <code>welcome</code> 缓冲区以及 <code>snprintf()</code> 将我们的字符串 <code>KILO_VERSION</code> 插入到欢迎消息中. 我们还截断了字符串的长度, 以防终端太小而无法容纳我们的欢迎消息.</p>
</div>
<div class="paragraph">
<p>现在让我们把它居中.</p>
</div>
<div class="listingblock">
<div class="title">第 42 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">[</span><span class="tok-mi">80</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snprintf</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">),</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-s">&quot;Kilo editor -- version %s&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">KILO_VERSION</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">padding</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">padding</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">padding</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">padding</span><span class="tok-o">--</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot; &quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[K&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>要使字符串居中, 请将屏幕宽度除以 <code>2</code>, 然后从中减去字符串长度的一半. 换句话说: <code>E.screencols/2 - welcomelen/2</code> 简化为 <code>(E.screencols - welcomelen) / 2</code>. 这告诉你应该从屏幕的左边缘多远开始打印字符串. 所以我们用空格字符填充那个空间, 除了第一个字符, 它应该是波浪号.</p>
</div>
</div>
<div class="sect2">
<h3 id="_移动光标">3.15. 移动光标</h3>
<div class="paragraph">
<p>现在让我们关注输入. 我们希望用户能够移动光标. 第一步是跟踪光标在全局编辑器状态中的位置 <code>x</code> 和 <code>y</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 43 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">cx</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">cy</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">initEditor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">getWindowSize</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;getWindowSize&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>E.cx</code> 是光标(列)的水平坐标, <code>E.cy</code> 是垂直坐标(行). 我们将它们都初始化为 <code>0</code>, 因为我们希望光标从屏幕的左上角开始. (由于 C 语言使用从 <code>0</code> 开始的索引, 我们将尽可能使用 <code>0</code> 索引值.)</p>
</div>
<div class="paragraph">
<p>现在让我们在 <code>editorRefreshScreen()</code> 中添加代码来将光标移动到存储在 <code>E.cx</code> 和 <code>E.cy</code> 中的位置.</p>
</div>
<div class="listingblock">
<div class="title">第 44 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ABUF_INIT</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25l&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">editorDrawRows</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">32</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">snprintf</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[%d;%dH&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">buf</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">strlen</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">));</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25h&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abFree</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>strlen()</code> 来自 <code>&lt;string.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p>我们将旧的 <code>H</code> 命令更改为带参数的 <code>H</code> 命令, 指定我们希望光标移动到的确切位置. (确保你删除了旧的 <code>H</code> 命令, 因为上面的差异很容易错过.)</p>
</div>
<div class="paragraph">
<p>我们为 <code>E.cy</code> 和 <code>E.cx</code> 都加 <code>1</code>, 将 <code>0</code> 索引值转换为终端使用的 <code>1</code> 索引值.</p>
</div>
<div class="paragraph">
<p>此时, 你可以尝试初始化E.cx或10插入E.cx++到主循环中, 以确认代码到目前为止是否按预期工作.</p>
</div>
<div class="paragraph">
<p>接下来, 我们将允许用户使用 <code>w</code>, <code>a</code>, <code>s</code>, <code>d</code> 键移动光标. (如果你不熟悉将这些键用作箭头键: <code>w</code> 是向上箭头, <code>s</code> 是向下箭头, <code>a</code> 是左箭头, <code>d</code> 是右箭头.)</p>
</div>
<div class="listingblock">
<div class="title">第 45 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;a&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;d&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;w&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;s&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;w&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;s&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;a&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;d&#39;</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在你应该可以使用这些键移动光标了.</p>
</div>
</div>
<div class="sect2">
<h3 id="_方向键">3.16. 方向键</h3>
<div class="paragraph">
<p>现在我们有了一种映射按键来移动光标的方法, 让我们用箭头键替换按键`w`, <code>a</code>, <code>s</code>, <code>d</code>. 上一章我们看到按下箭头键会发送多个字节作为我们程序的输入. 这些字节采用转义序列的形式, 以 <code>'\x1b'</code>, <code>'['</code> 开头, 后面跟着 <code>'A'</code>, <code>'B'</code> 或 <code>'C'</code>, <code>'D'</code>. 具体取决于按下的是四个箭头键中的哪一个. 让我们修改 <code>editorReadKey()</code> 来将这种形式的转义序列读取为单个按键.</p>
</div>
<div class="listingblock">
<div class="title">第 46 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">nread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;[&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;A&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;w&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;B&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;s&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;C&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;d&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;D&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;a&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果我们读取一个转义字符, 我们会立即将两个字节读入缓冲区 <code>seq</code>. 如果其中任何一个读取超时( <code>0.1</code> 秒后), 那么我们假设用户只是按下了键 <code>Escape</code> 并返回了它. 否则我们查看转义序列是否是箭头键转义序列. 如果是, 我们现在只返回相应的字符 <code>w</code>, <code>a</code>, <code>s</code>, <code>d</code>. 如果它不是我们识别的转义序列, 我们就返回转义字符.</p>
</div>
<div class="paragraph">
<p>我们将 <code>seq</code> 缓冲区设为 <code>3</code> 个字节长, 因为我们将来会处理更长的转义序列.</p>
</div>
<div class="paragraph">
<p>我们基本上将箭头键别名为 <code>wasd</code> 按键. 这使箭头键立即起作用, 但键 <code>wasd</code> 仍然映射到 <code>editorMoveCursor()</code> 函数. 我们想要的是 <code>editorReadKey()</code> 为每个箭头键返回特殊值, 让我们识别按下了特定的箭头键.</p>
</div>
<div class="paragraph">
<p>让我们首先用常量 <code>ARROW_UP</code>, <code>ARROW_LEFT</code>, <code>ARROW_DOWN</code> 和 <code>ARROW_RIGHT</code> 分别替换 <code>wasd</code> 按键.</p>
</div>
<div class="listingblock">
<div class="title">第 47 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>

<span class="tok-cp">#define KILO_VERSION &quot;0.0.1&quot;</span>

<span class="tok-cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span>

<span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-n">editorKey</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_LEFT</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;a&#39;</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;d&#39;</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_UP</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;w&#39;</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_DOWN</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;s&#39;</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">nread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;[&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;A&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;B&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;C&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;D&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_LEFT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_LEFT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_RIGHT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_LEFT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_RIGHT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在我们只需要在 <code>editorKey</code> 枚举中选择一个与 <code>wasd</code> 按键不冲突的箭头键表示. 我们会给它们一个超出 <code>char</code> 范围的大整数值, 这样它们就不会与任何普通按键发生冲突. 我们还必须将所有存储按键的变量更改为类型 <code>int</code> 而不是 <code>char</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 48 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>

<span class="tok-cp">#define KILO_VERSION &quot;0.0.1&quot;</span>

<span class="tok-cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span>

<span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-n">editorKey</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_LEFT</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1000</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_UP</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_DOWN</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">nread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;[&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;A&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;B&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;C&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;D&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_LEFT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_LEFT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_RIGHT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_LEFT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_RIGHT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>通过将枚举中的第一个常量设置为 <code>1000</code>, 其余常量将获得递增的值 <code>1001</code>, <code>1002</code>, <code>1003</code>, 依此类推.</p>
</div>
<div class="paragraph">
<p>我们的箭头键处理代码到此结束. 此时, 尝试在程序运行时手动输入转义序列会很有趣. 尝试按 <code>Escape</code> 键, <code>[</code> 键, 然后非常快的按照顺序按下 <code>Shift+C</code>, 你可能会看到你的按键被解释为按下右箭头键. 你必须非常快才能做到这一点, 所以你可能想暂时调整 <code>enableRawMode()</code> 中的值 <code>VTIME</code>, 让它更容易. (这也有助于了解按下 <code>Ctrl-[</code> 按下键 <code>Escape</code> 相同, 原因与按下 <code>Ctrl-M</code> 和按下 <code>Enter</code> 相同的原因是一样的: <code>Ctrl</code> 清除你键入的字符的第 <code>6</code> 位和第 <code>7</code> 位.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_防止将光标移出屏幕">3.17. 防止将光标移出屏幕</h3>
<div class="paragraph">
<p>目前, 你可以使 <code>E.cx</code> 和 <code>E.cy</code> 的值变成负数, 或者越过屏幕的右边缘和下边缘. 让我们在 <code>editorMoveCursor()</code> 中进行一些边界检查来防止这种情况发生.</p>
</div>
<div class="listingblock">
<div class="title">第 49 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_LEFT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_RIGHT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-o">++</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_page_up_和_page_down">3.18. Page Up 和 Page Down</h3>
<div class="paragraph">
<p>为了完成我们的底层终端代码, 我们需要检测一些使用转义序列的特殊按键, 就像箭头键一样. 我们将从 <code>Page Up</code> 和 <code>Page Down</code> 开始. 按下 <code>Page Up</code> 发送 <code>&lt;esc&gt;[5~</code>, 按下 <code>Page Down</code> 发送 <code>&lt;esc&gt;[6~</code>.</p>
</div>
<div class="listingblock">
<div class="title">第 50 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>

<span class="tok-cp">#define KILO_VERSION &quot;0.0.1&quot;</span>

<span class="tok-cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span>

<span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-n">editorKey</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_LEFT</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1000</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_UP</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">PAGE_UP</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">PAGE_DOWN</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">nread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;[&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-sc">&#39;0&#39;</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&lt;=</span><span class="tok-w"> </span><span class="tok-sc">&#39;9&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;~&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;5&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">PAGE_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;6&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">PAGE_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;A&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;B&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;C&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;D&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_LEFT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在你明白为什么我们声明 <code>seq</code> 存储 <code>3</code> 个字节了. 如果 <code>[</code> 后面的字节是一个数字, 我们期望读取的另一个字节是一个 <code>~</code>. 然后我们测试数字字节以查看它是 <code>5</code> 还是 <code>6</code>.</p>
</div>
<div class="paragraph">
<p>让我们用 <code>Page Up</code> 和 <code>Page Down</code> 做些什么. 现在, 我们将让它们将光标移动到屏幕顶部或屏幕底部.</p>
</div>
<div class="listingblock">
<div class="title">第 51 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">PAGE_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">PAGE_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">times</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">times</span><span class="tok-o">--</span><span class="tok-p">)</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-n">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">PAGE_UP</span><span class="tok-w"> </span><span class="tok-o">?</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span> <span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_LEFT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_RIGHT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们用那对大括号创建一个代码块, 这样我们就可以声明变量 <code>times</code> 了. (你不能直接在 <code>switch</code> 语句中声明变量.) 我们模拟用户按下 <code>↑</code> 或 <code>↓</code> 键足够多次以移动到屏幕的顶部或底部. 以这种方式实现 <code>Page Up</code> 和 <code>Page Down</code> 将使我们以后在实现滚动时更容易.</p>
</div>
<div class="paragraph">
<p>如果你使用的是带按键 <code>Fn</code> 的笔记本电脑, 则可以按 <code>Fn+↑</code> 和 <code>Fn+↓</code> 来模拟按 <code>Page Up</code> 和 <code>Page Down</code> 键.</p>
</div>
</div>
<div class="sect2">
<h3 id="_home_和_end">3.19. Home 和 End</h3>
<div class="paragraph">
<p>现在让我们实现 <code>Home</code> 和 <code>End</code> 键. 与前面的键一样, 这些键也发送转义序列. 与之前的按键不同的地方在于, 这些按键可以发送许多不同的转义序列, 具体取决于你的操作系统或终端仿真器. 按下 <code>Home</code> 键可能发送的转义序列有: <code>&lt;esc&gt;[1~</code>, <code>&lt;esc&gt;[7~</code>, <code>&lt;esc&gt;[H</code> 以及 <code>&lt;esc&gt;OH</code>. 按下 <code>End</code> 键可能发送的转义序列有: <code>&lt;esc&gt;[4~</code>, <code>&lt;esc&gt;[8~</code>, <code>&lt;esc&gt;[F</code> 以及 <code>&lt;esc&gt;OF</code>. 让我们处理这些情况.</p>
</div>
<div class="listingblock">
<div class="title">第 52 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>

<span class="tok-cp">#define KILO_VERSION &quot;0.0.1&quot;</span>

<span class="tok-cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span>

<span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-n">editorKey</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_LEFT</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1000</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_UP</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">HOME_KEY</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">END_KEY</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">PAGE_UP</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">PAGE_DOWN</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">nread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;[&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-sc">&#39;0&#39;</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&lt;=</span><span class="tok-w"> </span><span class="tok-sc">&#39;9&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;~&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;1&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;4&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;5&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">PAGE_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;6&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">PAGE_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;7&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;8&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;A&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;B&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;C&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;D&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_LEFT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;H&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;F&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;O&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;H&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;F&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在让我们用 <code>Home</code> 和 <code>End</code> 按键做点什么. 现在, 我们将让它们将光标移动到屏幕的左边缘或右边缘.</p>
</div>
<div class="listingblock">
<div class="title">第 53 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorProcessKeypress</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">editorReadKey</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-n">CTRL_KEY</span><span class="tok-p">(</span><span class="tok-sc">&#39;q&#39;</span><span class="tok-p">)</span><span class="tok-o">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[2J&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">4</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">exit</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">HOME_KEY</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">END_KEY</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">PAGE_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">PAGE_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">times</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">times</span><span class="tok-o">--</span><span class="tok-p">)</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-n">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">PAGE_UP</span><span class="tok-w"> </span><span class="tok-o">?</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span> <span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_UP</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_DOWN</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_LEFT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-nl">ARROW_RIGHT</span><span class="tok-p">:</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">editorMoveCursor</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果你使用的是带 <code>Fn</code> 键的笔记本电脑, 则可以用 <code>Fn+←</code> 和 <code>Fn+→</code> 来模拟 <code>Home</code> 和 <code>End</code> 键.</p>
</div>
</div>
<div class="sect2">
<h3 id="_delete">3.20. Delete</h3>
<div class="paragraph">
<p>最后, 让我们检测 <code>Delete</code> 按键何时被按下. 它只是发送转义序列 <code>&lt;esc&gt;[3~</code>, 因此很容易添加到我们的 <code>switch</code> 语句中. 我们暂时不会用这个按键做任何事情.</p>
</div>
<div class="listingblock">
<div class="title">第 54 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>

<span class="tok-cp">#define KILO_VERSION &quot;0.0.1&quot;</span>

<span class="tok-cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)</span>

<span class="tok-k">enum</span><span class="tok-w"> </span><span class="tok-n">editorKey</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_LEFT</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1000</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_UP</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">DEL_KEY</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">HOME_KEY</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">END_KEY</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">PAGE_UP</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">PAGE_DOWN</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">nread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">((</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">))</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">nread</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">errno</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">EAGAIN</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;read&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;[&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-sc">&#39;0&#39;</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">&lt;=</span><span class="tok-w"> </span><span class="tok-sc">&#39;9&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">STDIN_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;~&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;1&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;3&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">DEL_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;4&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;5&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">PAGE_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;6&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">PAGE_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;7&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;8&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;A&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_UP</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;B&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_DOWN</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;C&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_RIGHT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;D&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">ARROW_LEFT</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;H&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;F&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;O&#39;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">switch</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">seq</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;H&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">HOME_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">case</span><span class="tok-w"> </span><span class="tok-sc">&#39;F&#39;</span><span class="tok-o">:</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">END_KEY</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-sc">&#39;\x1b&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果你使用的是带 <code>Fn</code> 键的笔记本电脑, 则可以按 <code>Fn+退格键</code> 来模拟按下 <code>Delete</code> 键.</p>
</div>
<div class="paragraph">
<p>在下一章中, 我们将让我们的程序显示文本文件, 完成垂直和水平滚动以及状态栏.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_文本阅读器">4. 文本阅读器</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_行阅读器">4.1. 行阅读器</h3>
<div class="paragraph">
<p>让我们创建一种数据类型, 用来保存文本编辑器中的一行.</p>
</div>
<div class="listingblock">
<div class="title">第 55 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>

<span class="hll"><span class="tok-k">typedef</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">erow</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">size</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">chars</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-n">erow</span><span class="tok-p">;</span><span class="tok-w"></span>
</span>
<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">cx</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">cy</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">numrows</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">erow</span><span class="tok-w"> </span><span class="tok-n">row</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">initEditor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">numrows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">getWindowSize</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;getWindowSize&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>erow</code> 表示 <code>editor row</code>, 它保存文本中的一行, 使用指针类型保存, 这样可以动态分配字符串以及长度. <code>typedef</code> 类型别名让我们可以直接使用 <code>erow</code> 而不是 <code>struct erow</code>.</p>
</div>
<div class="paragraph">
<p>我们将一个 <code>erow</code> 值添加到文本编辑器的全局状态, 就像 <code>numrows</code> 变量一样. 现在, 文本编辑器只能显示一行文本, 所以 <code>numrows</code> 可能是 <code>0</code> 或者 <code>1</code>. 我们在 <code>initEditor()</code> 中将 <code>numrows</code> 初始化为 <code>0</code>.</p>
</div>
<div class="paragraph">
<p>让我们在 <code>erow</code> 中添加一些文本. 我们还不需要担心从文件中读取文本的事情. 我们先硬编码一个 <code>"Hello, world"</code> 字符串在里面.</p>
</div>
<div class="listingblock">
<div class="title">第 56 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>

<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;errno.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;string.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;sys/ioctl.h&gt;</span><span class="tok-cp"></span>
<span class="hll"><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;sys/types.h&gt;</span><span class="tok-cp"></span>
</span><span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">die</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">disableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">enableRawMode</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">editorReadKey</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getCursorPosition</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">getWindowSize</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">rows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">cols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="hll"><span class="tok-cm">/*** file i/o ***/</span><span class="tok-w"></span>
</span><span class="hll">
</span><span class="hll"><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorOpen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">line</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;Hello, world!&quot;</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">ssize_t</span><span class="tok-w"> </span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">13</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">size</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">linelen</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">line</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">linelen</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-p">[</span><span class="tok-n">linelen</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">numrows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">initEditor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">initEditor</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">editorOpen</span><span class="tok-p">();</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorRefreshScreen</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorProcessKeypress</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>malloc()</code> 来自 <code>&lt;stdlib.h&gt;</code>. <code>ssize_t</code> 来自 <code>&lt;sys/types.h&gt;</code>.</p>
</div>
<div class="paragraph">
<p><code>editorOpen()</code> 最终将打开和读取磁盘上的一个文件, 所以我们把它放在一个新的 <code>/<strong>* file i/o </strong>*/</code> 部分. 为了将 <code>"Hello, world"</code> 字符串加载到文本编辑器的 <code>erow</code> 结构体中, 我们先将 <code>size</code> 字段设置为字符串的长度, 然后调用 <code>malloc()</code> 分配内存, 然后调用 <code>memcpy()</code> 将字符串拷贝到 <code>chars</code> 字段. <code>chars</code> 字段指向分配的内存. 最后, 我们将 <code>E.numrows</code> 变量设置为 <code>1</code>, 表示 <code>erow</code> 目前包含一行需要显示的文本.</p>
</div>
<div class="paragraph">
<p>让我们来显示这行文本.</p>
</div>
<div class="listingblock">
<div class="title">第 57 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** file i/o ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">numrows</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">[</span><span class="tok-mi">80</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snprintf</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">),</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-s">&quot;Kilo editor -- version %s&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">KILO_VERSION</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">padding</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">padding</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-n">padding</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">padding</span><span class="tok-o">--</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot; &quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">size</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
</span><span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[K&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">第 58 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** file i/o ***/</span><span class="tok-w"></span>

<span class="hll"><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorOpen</span><span class="tok-p">(</span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">filename</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">FILE</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">fp</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">fopen</span><span class="tok-p">(</span><span class="tok-n">filename</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;r&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">fp</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;fopen&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
</span>
<span class="hll"><span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">line</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">NULL</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">size_t</span><span class="tok-w"> </span><span class="tok-n">linecap</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">ssize_t</span><span class="tok-w"> </span><span class="tok-n">linelen</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">getline</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">line</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">linecap</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">fp</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\n&#39;</span><span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">                           </span><span class="tok-n">line</span><span class="tok-p">[</span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-sc">&#39;\r&#39;</span><span class="tok-p">))</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">      </span><span class="tok-n">linelen</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-w">    </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">size</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">linelen</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">malloc</span><span class="tok-p">(</span><span class="tok-n">linelen</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">memcpy</span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">line</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">linelen</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-p">[</span><span class="tok-n">linelen</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-sc">&#39;\0&#39;</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">numrows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">free</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">fclose</span><span class="tok-p">(</span><span class="tok-n">fp</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">initEditor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="hll"><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">argc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">argv</span><span class="tok-p">[])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-n">enableRawMode</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">initEditor</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">argc</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-n">editorOpen</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorRefreshScreen</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">editorProcessKeypress</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">第 59 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>

<span class="hll"><span class="tok-cp">#define _DEFAULT_SOURCE</span>
</span><span class="hll"><span class="tok-cp">#define _BSD_SOURCE</span>
</span><span class="hll"><span class="tok-cp">#define _GNU_SOURCE</span>
</span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;ctype.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;errno.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdio.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;stdlib.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;string.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;sys/ioctl.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;sys/types.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;termios.h&gt;</span><span class="tok-cp"></span>
<span class="tok-cp">#include</span><span class="tok-w"> </span><span class="tok-cpf">&lt;unistd.h&gt;</span><span class="tok-cp"></span>

<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** file i/o ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">第 60 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** file i/o ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&gt;=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">numrows</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">numrows</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="tok-w">        </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">[</span><span class="tok-mi">80</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snprintf</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">welcome</span><span class="tok-p">),</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-s">&quot;Kilo editor -- version %s&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">KILO_VERSION</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">padding</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">/</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">padding</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">          </span><span class="tok-n">padding</span><span class="tok-o">--</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">padding</span><span class="tok-o">--</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot; &quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcome</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">welcomelen</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;~&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">size</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-p">.</span><span class="tok-n">chars</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[K&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">      </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\r\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">2</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_多行">4.2. 多行</h3>
<div class="listingblock">
<div class="title">第 61 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>

<span class="tok-k">typedef</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">erow</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-n">erow</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">cx</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">cy</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screenrows</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">numrows</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">erow</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">row</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">termios</span><span class="tok-w"> </span><span class="tok-n">orig_termios</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-p">};</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">editorConfig</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** file i/o ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">initEditor</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">numrows</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">row</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">NULL</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">getWindowSize</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screenrows</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-mi">-1</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">die</span><span class="tok-p">(</span><span class="tok-s">&quot;getWindowSize&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">argc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">argv</span><span class="tok-p">[])</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">第 100 步: kilo.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cm">/*** includes ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** defines ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** data ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** terminal ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** row operations ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** file i/o ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** append buffer ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** output ***/</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorScroll</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawRows</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawStatusBar</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="hll"><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorDrawMessageBar</span><span class="tok-p">(</span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">ab</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[K&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">msglen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">strlen</span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">statusmsg</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">msglen</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">msglen</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">screencols</span><span class="tok-p">;</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">msglen</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-n">time</span><span class="tok-p">(</span><span class="tok-nb">NULL</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">statusmsg_time</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-mi">5</span><span class="tok-p">)</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-w">    </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">statusmsg</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">msglen</span><span class="tok-p">);</span><span class="tok-w"></span>
</span><span class="hll"><span class="tok-p">}</span><span class="tok-w"></span>
</span>
<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorRefreshScreen</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">editorScroll</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-k">struct</span> <span class="tok-nc">abuf</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ABUF_INIT</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25l&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[H&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">3</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">editorDrawRows</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">editorDrawStatusBar</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="hll"><span class="tok-w">  </span><span class="tok-n">editorDrawMessageBar</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
</span>
<span class="tok-w">  </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-n">buf</span><span class="tok-p">[</span><span class="tok-mi">32</span><span class="tok-p">];</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">snprintf</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">sizeof</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[%d;%dH&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">cy</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">rowoff</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">                                            </span><span class="tok-p">(</span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">rx</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-n">E</span><span class="tok-p">.</span><span class="tok-n">coloff</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">buf</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">strlen</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">));</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">abAppend</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\x1b</span><span class="tok-s">[?25h&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-mi">6</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">STDOUT_FILENO</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ab</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">  </span><span class="tok-n">abFree</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">ab</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-nf">editorSetStatusMessage</span><span class="tok-p">(</span><span class="tok-k">const</span><span class="tok-w"> </span><span class="tok-kt">char</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-n">fmt</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-p">...)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-p">...</span><span class="tok-w"> </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cm">/*** input ***/</span><span class="tok-w"></span>
<span class="tok-cm">/*** init ***/</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-03-09 16:20:14 +0800
</div>
</div>
</body>
</html>